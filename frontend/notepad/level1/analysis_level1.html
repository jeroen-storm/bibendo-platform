<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse - Level 1</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
</head>
<body>
    <div class="container">
        
        <div id="aggregatedContent" class="aggregated-content">
            <!-- Aggregated content will be loaded here -->
        </div>
        
        <div class="question">
            <p>Waarom komen er weinig jongeren naar SneakSpot?</p>
        </div>
        
        <div class="form-group">
            <textarea 
                id="noteTextarea" 
                placeholder="Begin hier met typen..."
                maxlength="1000"
            ></textarea>
            <div class="char-counter">0/1000</div>
        </div>
        
        <div class="question">
            <p>Wat verkoopt SneakSpot op dit moment?</p>
        </div>
        
        <div class="form-group">
            <textarea 
                id="factorsTextarea" 
                placeholder="Begin hier met typen..."
                maxlength="1000"
            ></textarea>
            <div class="char-counter">0/1000</div>
        </div>
        
        <div class="question">
            <p>Wat moet SneakSpot veranderen om meer jongeren aan te trekken?</p>
        </div>
        
        <div class="form-group">
            <textarea 
                id="futureTextarea" 
                placeholder="Begin hier met typen..."
                maxlength="1000"
            ></textarea>
            <div class="char-counter">0/1000</div>
        </div>
        
        <!-- Verstuur naar Emma button -->
        <div class="submit-section">
            <button id="submitToEmma" class="submit-button">Verstuur naar Emma</button>
        </div>
        
        <!-- Auto-save status indicator -->
        <div class="status-message auto-save-status" id="statusMessage"></div>
        
        <!-- Emma submission overlay -->
        <div class="emma-overlay" id="emmaOverlay">
            <div class="emma-popup">
                <div class="emma-icon">âœ…</div>
                <p class="emma-message">Je analyse is verzonden naar Emma! Ze gaat hem nu bekijken en laten weten wat ze ervan vindt.</p>
            </div>
        </div>
        
    </div>
    
    <script src="../../assets/js/notepad.js"></script>
    <script>
        // Simple multi-textarea functionality for final pages
        class AnalysisManager {
            constructor() {
                this.userId = this.getUserId();
                this.pageId = 'analysis_level1';  // Analysis has its own pageId
                // Map textareas to field numbers within the analysis
                this.textareaMapping = {
                    'noteTextarea': 1,      // Field 1 of analysis
                    'factorsTextarea': 2,   // Field 2 of analysis
                    'futureTextarea': 3     // Field 3 of analysis
                };
                this.textareas = Object.keys(this.textareaMapping);
                this.init();
            }
            
            getUserId() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('userId') || 'anonymous';
            }
            
            init() {
                // Set up auto-save for all textareas
                this.textareas.forEach(id => {
                    const textarea = document.getElementById(id);
                    if (textarea) {
                        textarea.addEventListener('input', () => {
                            this.updateCharCounter(textarea);
                            this.scheduleAutoSave();
                        });
                    }
                });

                // Submit to Emma
                const submitButton = document.getElementById('submitToEmma');
                if (submitButton) {
                    submitButton.addEventListener('click', () => this.submitToEmma());
                }

                // Load existing content
                this.loadExistingContent();
            }

            updateCharCounter(textarea) {
                const charCounter = textarea.parentNode.querySelector('.char-counter');
                if (charCounter) {
                    const currentLength = textarea.value.length;
                    const maxLength = 1000;
                    charCounter.textContent = `${currentLength}/${maxLength}`;

                    charCounter.classList.remove('warning', 'error');
                    if (currentLength > maxLength * 0.9) {
                        charCounter.classList.add('warning');
                    }
                    if (currentLength >= maxLength) {
                        charCounter.classList.add('error');
                    }
                }
            }
            
            scheduleAutoSave() {
                if (this.autoSaveTimer) clearTimeout(this.autoSaveTimer);
                this.autoSaveTimer = setTimeout(() => this.saveContent(), 1500);
            }
            
            async saveContent() {
                // Save each textarea as a separate content item with field number
                const savePromises = this.textareas.map(async (textareaId) => {
                    const textarea = document.getElementById(textareaId);
                    const fieldNumber = this.textareaMapping[textareaId];

                    if (textarea && fieldNumber) {
                        return fetch('/api/content/save', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: this.userId,
                                pageId: this.pageId,  // Save to analysis_level1
                                contentType: 'analysis',
                                content: textarea.value,
                                fieldNumber: fieldNumber  // Field 1, 2, or 3
                            })
                        });
                    }
                });

                try {
                    await Promise.all(savePromises.filter(Boolean));
                    console.log('Saved all analysis fields');
                } catch (error) {
                    console.error('Error saving:', error);
                }
            }
            
            async loadExistingContent() {
                // Load analysis content from V2 API
                try {
                    const response = await fetch(`/api/content/${this.userId}/${this.pageId}`);
                    if (response.ok) {
                        const contentItems = await response.json();

                        // Load each field by field number
                        contentItems.forEach(item => {
                            if (item.field_number) {
                                // Find textarea by field number
                                const textareaId = Object.keys(this.textareaMapping).find(
                                    key => this.textareaMapping[key] === item.field_number
                                );

                                if (textareaId) {
                                    const textarea = document.getElementById(textareaId);
                                    if (textarea && item.content) {
                                        textarea.value = item.content;
                                        this.updateCharCounter(textarea);
                                        console.log(`Loaded field ${item.field_number}:`, item.content.substring(0, 50));
                                    }
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading analysis content:', error);
                }
            }
            
            async submitToEmma() {
                await this.saveContent();
                const overlay = document.getElementById('emmaOverlay');
                if (overlay) {
                    overlay.classList.add('show');
                    setTimeout(() => {
                        overlay.classList.remove('show');
                        // Make page 20% transparent after submission
                        this.makePageTransparent();
                    }, 4000);
                }
            }

            makePageTransparent() {
                const container = document.querySelector('.container');
                if (container) {
                    container.style.opacity = '0.2';
                    container.style.pointerEvents = 'none';
                }
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new AnalysisManager();
        });
    </script>

    <!-- Exit Intent Modal -->
    <div id="exitIntentModal" class="exit-intent-overlay" style="display: none;">
        <div class="exit-intent-popup">
            <div class="exit-intent-header">
                <img src="../../assets/images/karim_popup.png" alt="Karim" class="exit-intent-avatar">
                <h3>Hey, weet je zeker dat je klaar bent?</h3>
            </div>
            <div class="exit-intent-actions">
                <button id="continueWriting" class="exit-intent-btn-secondary">Sluiten</button>
            </div>
        </div>
    </div>

    <script>
        // Exit Intent functionality
        let exitIntentShown = false;
        let isLeavingPage = false;

        function checkTextAmount() {
            const noteTextarea = document.getElementById('noteTextarea');
            const factorsTextarea = document.getElementById('factorsTextarea');
            const futureTextarea = document.getElementById('futureTextarea');

            const totalChars = (noteTextarea?.value || '').length +
                             (factorsTextarea?.value || '').length +
                             (futureTextarea?.value || '').length;

            return totalChars >= 50; // Require at least 50 characters total
        }

        function showExitIntentModal() {
            if (exitIntentShown || isLeavingPage) return;
            if (!checkTextAmount()) return; // Only show if user has written something

            const modal = document.getElementById('exitIntentModal');
            if (modal) {
                modal.style.display = 'flex';
                exitIntentShown = true;
            }
        }

        function hideExitIntentModal() {
            const modal = document.getElementById('exitIntentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Mouse leave detection
        document.addEventListener('mousemove', (e) => {
            if (e.clientY <= 10 && !exitIntentShown) {
                showExitIntentModal();
            }
        });

        // Close modal buttons
        const continueBtn = document.getElementById('continueWriting');
        if (continueBtn) {
            continueBtn.addEventListener('click', hideExitIntentModal);
        }

        // Before unload
        window.addEventListener('beforeunload', () => {
            isLeavingPage = true;
        });
    </script>
</body>
</html>