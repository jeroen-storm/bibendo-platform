<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse - Level 1</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
</head>
<body>
    <div class="container">
        
        <div id="aggregatedContent" class="aggregated-content">
            <!-- Aggregated content will be loaded here -->
        </div>
        
        <div class="question">
            <p>Waarom komen er weinig jongeren naar SneakSpot?</p>
        </div>
        
        <div class="form-group">
            <textarea 
                id="noteTextarea" 
                placeholder="Begin hier met typen..."
                maxlength="1000"
            ></textarea>
            <div class="char-counter">0/1000</div>
        </div>
        
        <div class="question">
            <p>Wat verkoopt SneakSpot op dit moment?</p>
        </div>
        
        <div class="form-group">
            <textarea 
                id="factorsTextarea" 
                placeholder="Begin hier met typen..."
                maxlength="1000"
            ></textarea>
            <div class="char-counter">0/1000</div>
        </div>
        
        <div class="question">
            <p>Wat moet SneakSpot veranderen om meer jongeren aan te trekken?</p>
        </div>
        
        <div class="form-group">
            <textarea 
                id="futureTextarea" 
                placeholder="Begin hier met typen..."
                maxlength="1000"
            ></textarea>
            <div class="char-counter">0/1000</div>
        </div>
        
        <!-- Verstuur naar Emma button -->
        <div class="submit-section">
            <button id="submitToEmma" class="submit-button">Verstuur naar Emma</button>
        </div>
        
        <!-- Auto-save status indicator -->
        <div class="status-message auto-save-status" id="statusMessage"></div>
        
        <!-- Emma submission overlay -->
        <div class="emma-overlay" id="emmaOverlay">
            <div class="emma-popup">
                <div class="emma-icon">âœ…</div>
                <p class="emma-message">Je analyse is verzonden naar Emma! Ze gaat hem nu bekijken en laten weten wat ze ervan vindt.</p>
            </div>
        </div>
        
    </div>
    
    <script src="../../assets/js/notepad.js"></script>
    <script>
        // Simple multi-textarea functionality for final pages
        class AnalysisManager {
            constructor() {
                this.userId = this.getUserId();
                // Map textareas to their corresponding individual note pageIds
                this.textareaMapping = {
                    'noteTextarea': 'note1_level1',      // Maps to individual note 1
                    'factorsTextarea': 'note2_level1',   // Maps to individual note 2  
                    'futureTextarea': 'note3_level1'     // Maps to individual note 3
                };
                this.textareas = Object.keys(this.textareaMapping);
                this.init();
            }
            
            getUserId() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('userId') || 'anonymous';
            }
            
            init() {
                // Set up auto-save for all textareas
                this.textareas.forEach(id => {
                    const textarea = document.getElementById(id);
                    if (textarea) {
                        textarea.addEventListener('input', () => this.scheduleAutoSave());
                    }
                });
                
                // Submit to Emma
                const submitButton = document.getElementById('submitToEmma');
                if (submitButton) {
                    submitButton.addEventListener('click', () => this.submitToEmma());
                }
                
                // Load existing content
                this.loadExistingContent();
            }
            
            scheduleAutoSave() {
                if (this.autoSaveTimer) clearTimeout(this.autoSaveTimer);
                this.autoSaveTimer = setTimeout(() => this.saveContent(), 1500);
            }
            
            async saveContent() {
                // Save each textarea to its corresponding individual note page
                const savePromises = this.textareas.map(async (textareaId) => {
                    const textarea = document.getElementById(textareaId);
                    const pageId = this.textareaMapping[textareaId];
                    
                    if (textarea && pageId) {
                        return fetch('/api/notes/save', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: this.userId,
                                pageId: pageId,  // Save to individual note pageId
                                content: textarea.value,  // Save as plain text, not JSON
                                editCount: 1,
                                timeSpent: 0
                            })
                        });
                    }
                });
                
                try {
                    await Promise.all(savePromises.filter(Boolean));
                    console.log('Saved all textareas to individual notes');
                } catch (error) {
                    console.error('Error saving:', error);
                }
            }
            
            async loadExistingContent() {
                // Load each textarea from its corresponding individual note page
                const loadPromises = this.textareas.map(async (textareaId) => {
                    const pageId = this.textareaMapping[textareaId];
                    const textarea = document.getElementById(textareaId);
                    
                    if (!textarea || !pageId) return;
                    
                    try {
                        const response = await fetch(`/api/notes/${this.userId}/${pageId}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.content) {
                                textarea.value = data.content;  // Load plain text content
                                console.log(`Loaded ${textareaId} from ${pageId}:`, data.content.substring(0, 50));
                            }
                        }
                    } catch (error) {
                        console.error(`Error loading ${textareaId} from ${pageId}:`, error);
                    }
                });
                
                await Promise.all(loadPromises);
                console.log('Loaded all textareas from individual notes');
            }
            
            async submitToEmma() {
                await this.saveContent();
                const overlay = document.getElementById('emmaOverlay');
                if (overlay) {
                    overlay.classList.add('show');
                    setTimeout(() => overlay.classList.remove('show'), 4000);
                }
            }
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new AnalysisManager();
        });
    </script>
</body>
</html>