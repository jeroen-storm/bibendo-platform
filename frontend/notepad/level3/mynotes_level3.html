<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mijn aantekeningen</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <style>
        .notes-overview {
            margin-top: 30px;
        }
        
        .note-section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .note-section h3 {
            color: #00C2CB;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .note-label {
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .note-content {
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 60px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }
        
        .empty-note {
            color: #999;
            font-style: italic;
        }
        
        .section-header {
            color: #333;
            font-size: 1.2em;
            margin-bottom: 15px;
            margin-top: 30px;
        }
        
        .section-header:first-of-type {
            margin-top: 0;
        }
        
        .loading-message {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .overview-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .overview-header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .overview-header p {
            color: #666;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="overview-header">
            <h1>Mijn aantekeningen</h1>
        </div>
        
        <div id="loadingMessage" class="loading-message">
            Notities worden geladen...
        </div>
        
        <div id="notesContainer" class="notes-overview" style="display: none;">
            <!-- Analysis from Level 1 -->
            <h2 class="section-header">De analyse</h2>
            <div class="note-section">
                <div class="note-content" id="analysis_level1">
                    <span class="empty-note">Geen analyse gevonden</span>
                </div>
            </div>
            
            <!-- Message from Level 2 -->
            <h2 class="section-header">Mijn bericht aan Emma</h2>
            <div class="note-section">
                <div class="note-content" id="message_level2">
                    <span class="empty-note">Geen bericht gevonden</span>
                </div>
            </div>
            
            <!-- Level 3 Note 1 -->
            <h2 class="section-header">Activiteiten die we kunnen gebruiken</h2>
            <div class="note-section">
                <div class="note-content" id="note1_level3">
                    <span class="empty-note">Geen notitie gevonden</span>
                </div>
            </div>
            
            <!-- Level 3 Note 2 -->
            <h2 class="section-header">3 activiteiten van Sasha</h2>
            <div class="note-section">
                <div class="note-content" id="note2_level3">
                    <span class="empty-note">Geen notitie gevonden</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Get user ID from URL
        function getUserId() {
            const urlParams = new URLSearchParams(window.location.search);
            let userId = urlParams.get('userId');
            
            if (!userId) {
                const storedUserId = localStorage.getItem('bibendo_user_id');
                if (storedUserId) {
                    userId = storedUserId;
                } else {
                    userId = 'user_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('bibendo_user_id', userId);
                }
                
                urlParams.set('userId', userId);
                const newUrl = window.location.pathname + '?' + urlParams.toString();
                window.history.replaceState({}, '', newUrl);
            } else {
                localStorage.setItem('bibendo_user_id', userId);
            }
            
            return userId;
        }
        
        // Load all notes from database
        async function loadAllNotes() {
            const userId = getUserId();
            const notesToLoad = [
                // Analysis from individual notes (Level 1)
                { id: 'analysis_note1', pageId: 'note1_level1', label: 'Notitie 1' },
                { id: 'analysis_note2', pageId: 'note2_level1', label: 'Factoren' },
                { id: 'analysis_note3', pageId: 'note3_level1', label: 'Toekomst' },
                // Message from individual notes (Level 2)
                { id: 'message_note1', pageId: 'note1_level2', label: 'Notitie 1' },
                { id: 'message_note2', pageId: 'note2_level2', label: 'Communicatie' },
                // Level 3 Notes
                { id: 'note1_level3', pageId: 'note1_level3' },
                { id: 'note2_level3', pageId: 'note2_level3' }
            ];
            
            try {
                // Load all notes in parallel
                const promises = notesToLoad.map(note => 
                    fetch(`/api/notes/${userId}/${note.pageId}`)
                        .then(response => response.json())
                        .then(data => ({ ...note, content: data.content || '' }))
                        .catch(error => {
                            console.error(`Error loading ${note.pageId}:`, error);
                            return { ...note, content: '' };
                        })
                );
                
                const results = await Promise.all(promises);
                
                // Combine analysis notes
                const analysisNotes = results.filter(r => r.id.startsWith('analysis_'));
                const analysisContent = analysisNotes.map(note => {
                    if (note.content) {
                        return `${note.label}:\n${note.content}`;
                    }
                    return null;
                }).filter(content => content).join('\n\n');
                
                const analysisElement = document.getElementById('analysis_level1');
                if (analysisContent) {
                    analysisElement.textContent = analysisContent;
                } else {
                    analysisElement.innerHTML = '<span class="empty-note">Geen analyse gevonden</span>';
                }
                
                // Combine message notes
                const messageNotes = results.filter(r => r.id.startsWith('message_'));
                const messageContent = messageNotes.map(note => {
                    if (note.content) {
                        return `${note.label}:\n${note.content}`;
                    }
                    return null;
                }).filter(content => content).join('\n\n');
                
                const messageElement = document.getElementById('message_level2');
                if (messageContent) {
                    messageElement.textContent = messageContent;
                } else {
                    messageElement.innerHTML = '<span class="empty-note">Geen bericht gevonden</span>';
                }
                
                // Display Level 3 notes
                const level3Notes = results.filter(r => r.id.startsWith('note') && r.id.includes('level3'));
                level3Notes.forEach(result => {
                    const element = document.getElementById(result.id);
                    if (element) {
                        if (result.content) {
                            element.textContent = result.content;
                        } else {
                            element.innerHTML = '<span class="empty-note">Geen notitie gevonden</span>';
                        }
                    }
                });
                
                // Hide loading message and show notes
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('notesContainer').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading notes:', error);
                document.getElementById('loadingMessage').textContent = 'Er is een fout opgetreden bij het laden van de notities.';
            }
        }
        
        // Load notes when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadAllNotes();
        });
    </script>
</body>
</html>