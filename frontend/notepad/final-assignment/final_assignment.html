<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan voor Lancering - SneakSpot</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <style>
        
        .email-header {
            text-align: left;
            margin-bottom: 40px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }
        
        .email-header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
            font-family: Georgia, serif;
        }
        
        .email-body {
            line-height: 1.6;
            color: #333;
        }
        
        .email-greeting {
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .email-intro {
            margin-bottom: 25px;
            font-size: 1rem;
        }
        
        .email-section-intro {
            margin: 25px 0 15px 0;
            font-size: 1rem;
        }
        
        .email-field {
            margin: 15px 0 25px 0;
            position: relative;
        }
        
        .email-field textarea {
            width: 100%;
            border: 2px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        .email-field textarea:focus {
            outline: none;
            border-color: #00C2CB;
        }
        
        .field-explanation {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #666;
            background-color: #fff9e6;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e6e6e6;
        }
        
        .activity-list {
            display: none; /* Hidden but used for formatting reference */
        }
        
        .email-closing {
            margin: 30px 0 20px 0;
            font-size: 1rem;
        }
        
        .email-signature {
            margin: 30px 0;
            font-size: 1rem;
        }
        
        .document-header .subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 20px;
        }
        
        .context-text {
            font-size: 1rem;
            color: #555;
            margin-bottom: 30px;
            font-style: italic;
        }
        
        .section-header {
            font-size: 1.3rem;
            font-weight: 600;
            color: #00C2CB;
            margin: 40px 0 20px 0;
            border-left: 4px solid #00C2CB;
            padding-left: 15px;
            font-family: Georgia, serif;
        }
        
        .subsection {
            margin-bottom: 30px;
        }
        
        .launch-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .detail-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .detail-label {
            font-weight: 600;
            color: #666;
        }
        
        .requirements-list, .promotion-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }
        
        .requirements-list li, .promotion-list li {
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .requirements-list input[type="checkbox"], .promotion-list input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }
        
        
        
        
        /* Responsive design */
        @media (max-width: 768px) {
            .detail-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .document-header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <!-- Email Body -->
        <div class="email-body">
            <p class="email-greeting"><strong>Beste Emma Miller,</strong></p>
            
            <p class="email-intro">
                Een aantal weken geleden mailden u mij met de vraag waarom er weinig jongeren naar SneakSpot komen. 
                De afgelopen weken hebben wij hier onderzoek naar gedaan.
            </p>
            
            <p class="email-section-intro">
                We zijn begonnen met een <em>analyse</em> van SneakSpot. <strong>SneakSpot verkoopt op dit moment</strong> ...
            </p>
            
            <!-- Field 1: Products -->
            <div class="email-field">
                <textarea 
                    id="field1" 
                    placeholder="Begin hier met typen..."
                    maxlength="500"
                    style="height: 40px;"
                ></textarea>
                <div class="char-counter">0/500</div>
                <p class="field-explanation" id="note-display-1"><em>Je eerdere aantekening wordt hier getoond...</em></p>
            </div>
            
            <p>U gaf aan dat er op dit moment weinig jongeren naar SneakSpot komen. <strong>Er komen weinig jongeren naar SneakSpot, omdat</strong> ...</p>
            
            <!-- Field 2: Why few youth come -->
            <div class="email-field">
                <textarea 
                    id="field2" 
                    placeholder="Begin hier met typen..."
                    maxlength="500"
                    style="height: 40px;"
                ></textarea>
                <div class="char-counter">0/500</div>
                <p class="field-explanation" id="note-display-2"><em>Je eerdere aantekening wordt hier getoond...</em></p>
            </div>
            
            <p><strong>Om meer jongeren aan te trekken, moet SneakSpot sneakers verkopen die</strong> ...</p>
            
            <!-- Field 3: What needs to change -->
            <div class="email-field">
                <textarea 
                    id="field3" 
                    placeholder="Begin hier met typen..."
                    maxlength="500"
                    style="height: 40px;"
                ></textarea>
                <div class="char-counter">0/500</div>
                <p class="field-explanation" id="note-display-3"><em>Je eerdere aantekening wordt hier getoond...</em></p>
            </div>
            
            <p>Vervolgens zijn wij op zoek gegaan naar een <em>nieuwe sneakerstyle</em> voor SneakSpot, die past bij jongeren. <strong>Jongeren zijn op zoek naar een sneakerstyle</strong> ...</p>
            
            <!-- Field 4: Youth preferences -->
            <div class="email-field">
                <textarea 
                    id="field4" 
                    placeholder="Begin hier met typen..."
                    maxlength="500"
                    style="height: 40px;"
                ></textarea>
                <div class="char-counter">0/500</div>
                <p class="field-explanation" id="note-display-4"><em>Je eerdere aantekening wordt hier getoond...</em></p>
            </div>
            
            <p><strong>De sneakerstyle die volgens ons goed past bij SneakSpot is</strong> ...</p>
            
            <!-- Field 5: New sneaker style description -->
            <div class="email-field">
                <textarea 
                    id="field5" 
                    placeholder="Begin hier met typen..."
                    maxlength="500"
                    style="height: 40px;"
                ></textarea>
                <div class="char-counter">0/500</div>
                <p class="field-explanation" id="note-display-5"><em>Je eerdere aantekening wordt hier getoond...</em></p>
            </div>
            
            <p><strong>Deze sneakerstyle past goed bij SneakSpot, omdat</strong> ...</p>
            
            <!-- Field 6: Why it fits -->
            <div class="email-field">
                <textarea 
                    id="field6" 
                    placeholder="Begin hier met typen..."
                    maxlength="500"
                    style="height: 40px;"
                ></textarea>
                <div class="char-counter">0/500</div>
                <p class="field-explanation" id="note-display-6"><em>Je eerdere aantekening wordt hier getoond...</em></p>
            </div>
            
            <p>Om de nieuwe sneakerstyle aan de jongeren te laten zien, willen we een <em>lancering</em> organiseren. Bij de lancering horen activiteiten waarin jongeren de nieuwe sneakerstyle kunnen ontdekken. <strong>We hebben de activiteiten van kledingwinkel Loopz bekeken, en denken dat de volgende twee activiteiten goed zouden passen bij SneakSpot:</strong></p>
            
            <!-- Field 7: Loopz activities -->
            <div class="email-field">
                <div class="activity-list">
                    <p><strong>1.</strong> ...</p>
                    <p><strong>2.</strong> ...</p>
                </div>
                <textarea 
                    id="field7" 
                    placeholder="Begin hier met typen..."
                    maxlength="500"
                    style="height: 50px;"
                ></textarea>
                <div class="char-counter">0/500</div>
                <p class="field-explanation" id="note-display-7"><em>Je eerdere aantekening wordt hier getoond...</em></p>
            </div>
            
            <p>Om er zeker van te zijn dat deze activiteiten passen bij jongeren, hebben we Sasha, de eigenaresse van Loopz, gevraagd naar haar ervaring. <strong>Sasha gaf aan dat de volgende activiteiten geschikt zijn voor de lancering van SneakSpot:</strong></p>

            <!-- Field 8: Sasha activities -->
            <div class="email-field">
                <div class="activity-list">
                    <p><strong>1.</strong> ...</p>
                    <p><strong>2.</strong> ...</p>
                    <p><strong>3.</strong> ...</p>
                </div>
                <textarea
                    id="field8"
                    placeholder="Begin hier met typen..."
                    maxlength="500"
                    style="height: 60px;"
                ></textarea>
                <div class="char-counter">0/500</div>
            </div>

            <!-- Note display for field 8 -->
            <p class="field-explanation" id="note-display-8" style="background-color: #fff9e6; padding: 12px; border-radius: 4px; margin-top: 8px; margin-bottom: 20px;"><em>Je eerdere aantekening wordt hier getoond...</em></p>

            <p>We zijn op zoek gegaan naar een evenementenbureau dat geschikt is om de lancering van SneakSpot te organiseren. <strong>Voor de lancering van SneakSpot adviseren wij om...</strong></p>

            <!-- Field 10: Evenementenbureau advice -->
            <div class="email-field">
                <textarea
                    id="field10"
                    placeholder="Begin hier met typen..."
                    maxlength="500"
                    style="height: 60px;"
                ></textarea>
                <div class="char-counter">0/500</div>
            </div>

            <!-- Note display for field 10 (note3_level3) -->
            <p class="field-explanation" id="note-display-10" style="background-color: #fff9e6; padding: 12px; border-radius: 4px; margin-top: 8px; margin-bottom: 20px;"><em>Je eerdere aantekening wordt hier getoond...</em></p>

            <p>Als laatste zouden wij u graag een antwoord willen geven op de vraag die u ons stelde: <em>Wat moet er aan SneakSpot veranderen, zodat jongeren weer naar de winkel komen?</em> <strong>Om meer jongeren naar SneakSpot te laten komen, zouden wij adviseren om</strong> ...</p>
            
            <!-- Field 9: Final conclusion -->
            <div class="email-field">
                <textarea 
                    id="field9" 
                    placeholder="Begin hier met typen..."
                    maxlength="500"
                    style="height: 50px;"
                ></textarea>
                <div class="char-counter">0/500</div>
            </div>
            
            <p class="email-closing">Ik hoor graag wat u van dit idee vindt en of u het verder met mij wilt bespreken.</p>
            
            <p class="email-signature">
                <strong>Met vriendelijke groet,</strong><br><br>
                <strong>Karim</strong>
            </p>
        </div>
        
        <div style="text-align: center; margin: 40px 0;">
            <button id="submitPlan" style="
                padding: 15px 30px;
                background: #00C2CB;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.3s ease;
                min-width: 200px;
            " onmouseover="this.style.background='#00a8b0'" onmouseout="this.style.background='#00C2CB'">
                Verstuur naar Emma
            </button>
        </div>
        
        
        
        <!-- Save status -->
        <div class="status-message auto-save-status" id="statusMessage"></div>
    </div>

    <!-- Emma Success Overlay -->
    <div class="emma-overlay" id="emmaOverlay">
        <div class="emma-popup">
            <div class="emma-header">
                <h3>Email verzonden naar Emma!</h3>
            </div>
            <div class="emma-content">
                <p>Je email is succesvol naar Emma Miller verzonden.</p>
                <p>Ze zal contact met je opnemen over de volgende stappen voor SneakSpot.</p>
            </div>
            <div class="emma-actions">
                <button class="emma-close-btn" onclick="closeEmmaOverlay()" style="background: #00C2CB; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Sluiten</button>
            </div>
        </div>
    </div>

    <!-- Validation Error Overlay -->
    <div class="emma-overlay" id="validationOverlay">
        <div class="emma-popup">
            <div class="emma-header">
                <h3>Niet alle velden ingevuld</h3>
            </div>
            <div class="emma-content">
                <p>Vul eerst alle 8 velden in voordat je het plan kunt versturen naar Emma.</p>
                <p id="validationMessage">Je hebt nog <span id="missingFields">0</span> velden te gaan.</p>
            </div>
            <div class="emma-actions">
                <button class="emma-close-btn" onclick="closeValidationOverlay()" style="background: #00C2CB; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Sluiten</button>
            </div>
        </div>
    </div>
    
    <!-- Include necessary JavaScript -->
    <script src="../../assets/js/notepad.js"></script>
    <script>
        class EmailFinalAssignment {
            constructor() {
                this.fields = {};
                this.editCounts = {};
                this.timeSpent = {};
                this.fieldTimers = {};
                this.autoSaveTimeout = null;
                this.userId = this.getUserId();
                this.pageId = 'final_assignment';
                
                this.init();
            }
            
            getUserId() {
                const urlParams = new URLSearchParams(window.location.search);
                let userId = urlParams.get('userId');
                
                if (!userId) {
                    const storedUserId = localStorage.getItem('bibendo_user_id');
                    if (storedUserId) {
                        userId = storedUserId;
                    } else {
                        userId = 'user_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('bibendo_user_id', userId);
                    }
                    
                    urlParams.set('userId', userId);
                    const newUrl = window.location.pathname + '?' + urlParams.toString();
                    window.history.replaceState({}, '', newUrl);
                } else {
                    localStorage.setItem('bibendo_user_id', userId);
                }
                
                return userId;
            }
            
            async init() {
                console.log('Final Assignment initialized');
                
                // Note mapping for auto-population
                this.noteMapping = {
                    1: { pageId: 'note2_level1', field: 'single' },       // SneakSpot verkoopt
                    2: { pageId: 'note1_level1', field: 'single' },       // Weinig jongeren omdat
                    3: { pageId: 'note3_level1', field: 'single' },       // Om meer aan te trekken
                    4: { pageId: 'note1_level2', field: 'single' },       // Jongeren zoeken naar
                    5: { pageId: 'note2_level2', field: 'characteristics' }, // Urban Flow kenmerken
                    6: { pageId: 'note2_level2', field: 'reason' },       // Waarom past het bij SneakSpot
                    7: { pageId: 'note1_level3', field: 'single' },       // Loopz activiteiten
                    8: { pageId: 'note2_level3', field: 'single' },       // Sasha activiteiten
                    10: { pageId: 'note3_level3', field: 'single' },      // Evenementenbureau advice
                    9: { pageId: null, field: 'new' }                     // New conclusion field
                };

                // Initialize all fields (now 10 instead of 9)
                for (let i = 1; i <= 10; i++) {
                    this.fields[i] = document.getElementById(`field${i}`);
                    this.editCounts[i] = 0;
                    this.timeSpent[i] = 0;
                    this.fieldTimers[i] = null;
                    
                    if (this.fields[i]) {
                        this.setupFieldListeners(i);
                    }
                }
                
                // Load previous notes for auto-population (DISABLED - keep fields empty)
                // await this.loadPreviousNotes();
                
                // Display user notes under each field
                await this.displayUserNotes();
                
                // Load existing data (DISABLED - keep fields empty)
                // await this.loadData();
                
                // Start page time tracking
                this.startPageTimeTracking();
                
                // Setup submit button
                this.setupSubmitButton();
            }
            
            setupFieldListeners(fieldNumber) {
                const field = this.fields[fieldNumber];
                if (!field) return;

                // Focus event - start timer
                field.addEventListener('focus', () => {
                    this.startFieldTimer(fieldNumber);
                });

                // Blur event - stop timer
                field.addEventListener('blur', () => {
                    this.stopFieldTimer(fieldNumber);
                });

                // Input event - handle changes
                field.addEventListener('input', () => {
                    this.updateCharCounter(field);
                    this.handleFieldChange(fieldNumber);
                });
            }

            updateCharCounter(textarea) {
                const charCounter = textarea.parentNode.querySelector('.char-counter');
                if (charCounter) {
                    const currentLength = textarea.value.length;
                    const maxLength = parseInt(textarea.getAttribute('maxlength')) || 500;
                    charCounter.textContent = `${currentLength}/${maxLength}`;

                    charCounter.classList.remove('warning', 'error');
                    if (currentLength > maxLength * 0.9) {
                        charCounter.classList.add('warning');
                    }
                    if (currentLength >= maxLength) {
                        charCounter.classList.add('error');
                    }
                }
            }
            
            async loadPreviousNotes() {
                console.log('Loading previous notes for auto-population...');

                for (let i = 1; i <= 10; i++) {
                    if (i === 9) continue; // Skip field 9 (conclusion - no auto-population)

                    const mapping = this.noteMapping[i];
                    if (!mapping || !mapping.pageId) continue;
                    
                    try {
                        const response = await fetch(`/api/notes/${this.userId}/${mapping.pageId}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.content) {
                                let contentToPaste = '';
                                
                                // Handle dual-textarea pages (note2_level1, note2_level2)
                                if (mapping.field === 'products' || mapping.field === 'characteristics' || mapping.field === 'reason') {
                                    const separator = mapping.pageId === 'note2_level1' ? '--- Kenmerken ---' : '--- Waarom geschikt ---';
                                    const parts = data.content.split(separator);
                                    
                                    if (mapping.field === 'products' || mapping.field === 'characteristics') {
                                        contentToPaste = parts[0] ? parts[0].trim() : '';
                                    } else if (mapping.field === 'reason') {
                                        contentToPaste = parts[1] ? parts[1].trim() : '';
                                    }
                                } else {
                                    // Single textarea pages
                                    contentToPaste = data.content.trim();
                                }
                                
                                // Populate the field if textarea exists and is empty
                                const field = this.fields[i];
                                if (field && !field.value.trim() && contentToPaste) {
                                    field.value = contentToPaste;
                                    this.updateCharCounter(field);
                                    console.log(`Auto-populated field${i} from ${mapping.pageId}`);
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`Error loading ${mapping.pageId} for field${i}:`, error);
                    }
                }
            }
            
            startFieldTimer(fieldNumber) {
                if (this.fieldTimers[fieldNumber]) return;
                
                this.fieldTimers[fieldNumber] = setInterval(() => {
                    this.timeSpent[fieldNumber]++;
                    this.updateFieldStats(fieldNumber);
                }, 1000);
            }
            
            stopFieldTimer(fieldNumber) {
                if (this.fieldTimers[fieldNumber]) {
                    clearInterval(this.fieldTimers[fieldNumber]);
                    this.fieldTimers[fieldNumber] = null;
                }
            }
            
            handleFieldChange(fieldNumber) {
                this.editCounts[fieldNumber]++;
                this.updateFieldStats(fieldNumber);
                this.scheduleAutoSave();
            }
            
            updateFieldStats(fieldNumber) {
                const editElement = document.getElementById(`edit-count-${fieldNumber}`);
                const timeElement = document.getElementById(`time-spent-${fieldNumber}`);
                
                if (editElement) editElement.textContent = this.editCounts[fieldNumber];
                if (timeElement) timeElement.textContent = this.formatTime(this.timeSpent[fieldNumber]);
            }
            
            
            scheduleAutoSave() {
                clearTimeout(this.autoSaveTimeout);
                this.showSaveStatus('Opslaan...', 'saving');
                
                this.autoSaveTimeout = setTimeout(() => {
                    this.saveData();
                }, 1500);
            }
            
            async saveData() {
                try {
                    // Save each field as a separate content item with field number (V2 API)
                    const savePromises = [];

                    for (let i = 1; i <= 10; i++) {
                        const field = this.fields[i];
                        if (field) {
                            savePromises.push(
                                fetch('/api/content/save', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        userId: this.userId,
                                        pageId: this.pageId,
                                        contentType: 'assignment_field',
                                        content: field.value,
                                        fieldNumber: i
                                    })
                                })
                            );
                        }
                    }

                    await Promise.all(savePromises.filter(Boolean));
                    this.showSaveStatus('Opgeslagen', 'saved');

                } catch (error) {
                    console.error('Error saving final assignment:', error);
                    this.showSaveStatus('Fout bij opslaan', 'error');
                }
            }
            
            async displayUserNotes() {
                console.log('Displaying user notes under fields...');
                console.log('User ID:', this.userId);

                for (let i = 1; i <= 10; i++) {
                    if (i === 9) continue; // Skip field 9 (no note display)

                    const mapping = this.noteMapping[i];
                    if (!mapping || !mapping.pageId) continue;
                    
                    console.log(`Processing field ${i}, pageId: ${mapping.pageId}, field: ${mapping.field}`);
                    
                    const noteDisplay = document.getElementById(`note-display-${i}`);
                    if (!noteDisplay) {
                        console.log(`No note-display-${i} element found`);
                        continue;
                    }
                    
                    try {
                        const url = `/api/notes/${this.userId}/${mapping.pageId}`;
                        console.log(`Fetching: ${url}`);
                        const response = await fetch(url);
                        console.log(`Response status for ${mapping.pageId}:`, response.status);
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.content) {
                                let noteText = '';
                                
                                // Handle dual-textarea pages - show both parts
                                if (mapping.pageId === 'note2_level2') {
                                    // Check for old separator first (backward compatibility)
                                    const oldSeparator = '--- Waarom geschikt ---';
                                    const separator = data.content.includes(oldSeparator) ? oldSeparator : '\n\n';
                                    const parts = data.content.split(separator);
                                    if (mapping.field === 'characteristics') {
                                        // Field 5: Show characteristics part
                                        noteText = parts[0] ? parts[0].trim() : '';
                                    } else if (mapping.field === 'reason') {
                                        // Field 6: Show reason part
                                        noteText = parts[1] ? parts[1].trim() : '';
                                    }
                                } else {
                                    // Single textarea pages
                                    noteText = data.content.trim();
                                }
                                
                                if (noteText) {
                                    noteDisplay.innerHTML = `<em>${noteText}</em>`;
                                } else {
                                    noteDisplay.innerHTML = '<em>Geen aantekening gevonden...</em>';
                                }
                            } else {
                                noteDisplay.innerHTML = '<em>Geen aantekening gevonden...</em>';
                            }
                        } else {
                            noteDisplay.innerHTML = '<em>Geen aantekening gevonden...</em>';
                        }
                    } catch (error) {
                        console.error(`Error displaying note for field${i}:`, error);
                        noteDisplay.innerHTML = '<em>Fout bij laden aantekening...</em>';
                    }
                }
            }

            async loadData() {
                try {
                    // Load from V2 API with field_number
                    const response = await fetch(`/api/content/${this.userId}/${this.pageId}`);
                    if (response.ok) {
                        const contentItems = await response.json();

                        // Load each field by field number
                        contentItems.forEach(item => {
                            if (item.field_number && item.field_number >= 1 && item.field_number <= 10) {
                                const field = this.fields[item.field_number];
                                if (field && item.content) {
                                    field.value = item.content;
                                    this.updateCharCounter(field);
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading final assignment:', error);
                }
            }
            
            showSaveStatus(message, type = 'info') {
                const statusMessage = document.querySelector('.status-message');
                if (statusMessage) {
                    // Add icons to messages
                    let icon = '';
                    switch(type) {
                        case 'typing':
                            icon = 'âœï¸ ';
                            break;
                        case 'saving':
                            icon = 'ðŸ’¾ ';
                            break;
                        case 'saved':
                            icon = 'âœ… ';
                            break;
                        default:
                            icon = 'â„¹ï¸ ';
                    }
                    
                    statusMessage.innerHTML = icon + message;
                    statusMessage.className = `status-message auto-save-status ${type}`;
                    statusMessage.style.display = 'block';
                    
                    // Auto-hide messages
                    if (type === 'saved') {
                        setTimeout(() => {
                            if (statusMessage.classList.contains('saved')) {
                                statusMessage.style.display = 'none';
                            }
                        }, 3000);
                    }
                }
            }
            
            setupSubmitButton() {
                const submitButton = document.getElementById('submitPlan');
                if (submitButton) {
                    submitButton.addEventListener('click', () => this.submitPlan());
                }
            }
            
            async submitPlan() {
                // Check if all fields are filled (at least 7 out of 10)
                let filledFields = 0;
                for (let i = 1; i <= 10; i++) {
                    if (this.fields[i] && this.fields[i].value.trim()) {
                        filledFields++;
                    }
                }

                if (filledFields < 7) {
                    // Update validation message
                    const missingFields = 8 - filledFields;
                    document.getElementById('missingFields').textContent = missingFields;

                    // Show validation overlay
                    const validationOverlay = document.getElementById('validationOverlay');
                    if (validationOverlay) {
                        validationOverlay.classList.add('show');
                    }
                    return;
                }

                // Save current data first
                await this.saveData();

                // Show Emma overlay
                const overlay = document.getElementById('emmaOverlay');
                if (overlay) {
                    overlay.classList.add('show');

                    // Make page 20% transparent after 4 seconds
                    setTimeout(() => {
                        this.makePageTransparent();
                    }, 4000);
                }

                // Log the submission action
                try {
                    await fetch('/api/logs/text', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: this.userId,
                            pageId: this.pageId,
                            actionType: 'submit_to_emma',
                            data: JSON.stringify({
                                completedFields: filledFields,
                                timestamp: new Date().toISOString()
                            })
                        })
                    });
                } catch (error) {
                    console.error('Error logging submission:', error);
                }
            }

            makePageTransparent() {
                const container = document.querySelector('.container');
                if (container) {
                    container.style.opacity = '0.2';
                    container.style.pointerEvents = 'none';
                }
            }
            
            startPageTimeTracking() {
                // Track page time
                setInterval(() => {
                    this.logTimeSpent();
                }, 30000); // Every 30 seconds
            }
            
            async logTimeSpent() {
                try {
                    const data = {
                        userId: this.userId,
                        pageId: this.pageId,
                        timeSpent: 30 // 30 seconds
                    };
                    
                    await fetch('/api/logs/time', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                } catch (error) {
                    console.error('Error logging time:', error);
                }
            }
            
            formatTime(seconds) {
                if (seconds < 60) return `${seconds}s`;
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}m ${remainingSeconds}s`;
            }
        }
        
        // Close Emma overlay function
        function closeEmmaOverlay() {
            const overlay = document.getElementById('emmaOverlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }
        
        // Close validation overlay function
        function closeValidationOverlay() {
            const overlay = document.getElementById('validationOverlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.emailFinalAssignment = new EmailFinalAssignment();
        });
    </script>

    <!-- Exit Intent Modal -->
    <div id="exitIntentModal" class="exit-intent-overlay" style="display: none;">
        <div class="exit-intent-popup">
            <div class="exit-intent-header">
                <img src="../../assets/images/karim_popup.png" alt="Karim" class="exit-intent-avatar">
                <h3>Hey, weet je zeker dat je klaar bent?</h3>
            </div>
            <div class="exit-intent-actions">
                <button id="continueWriting" class="exit-intent-btn-secondary">Sluiten</button>
            </div>
        </div>
    </div>


    <script>
        // Exit Intent functionality for Final Assignment
        let exitIntentShown = false;
        let isLeavingPage = false;

        function checkTextAmount() {
            // Check if user has sufficient text across all fields
            let totalTextLength = 0;
            let fieldsWithText = 0;

            for (let i = 1; i <= 10; i++) {
                const field = document.getElementById(`field${i}`);
                if (field && field.value.trim()) {
                    totalTextLength += field.value.trim().length;
                    fieldsWithText++;
                }
            }
            
            // Require ALL 9 fields with text
            return fieldsWithText >= 9;
        }

        function showExitIntentModal() {
            if (!exitIntentShown && !isLeavingPage && !checkTextAmount()) {
                const modal = document.getElementById('exitIntentModal');
                if (modal) {
                    modal.style.display = 'flex';
                    setTimeout(() => modal.classList.add('show'), 10);
                    exitIntentShown = true;
                }
            }
        }

        // Exit intent detection using proven working approach
        document.addEventListener('mouseleave', (e) => {
            if (e.clientY <= 0) {
                showExitIntentModal();
            }
        });
        
        // Add mouse movement tracking for trigger zones
        document.addEventListener('mousemove', (e) => {
            // Check if mouse is in top-left trigger zone (back button area)
            if (e.clientX <= 150 && e.clientY <= 150) {
                // Mouse is in potential exit zone
            }
            
            // Check immediate exit intent on very top edge
            if (e.clientY <= 10) {
                showExitIntentModal();
            }
        });

        // Before unload detection
        window.addEventListener('beforeunload', (e) => {
            if (!checkTextAmount() && !isLeavingPage) {
                e.preventDefault();
                e.returnValue = 'Je hebt nog niet alle velden ingevuld. Weet je zeker dat je de pagina wilt verlaten?';
                return 'Je hebt nog niet alle velden ingevuld. Weet je zeker dat je de pagina wilt verlaten?';
            }
        });

        // Modal close functionality
        document.addEventListener('DOMContentLoaded', () => {
            const continueBtn = document.getElementById('continueWriting');
            const modal = document.getElementById('exitIntentModal');
            
            if (continueBtn) {
                continueBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                    // Reset so it can show again later if needed
                    exitIntentShown = false;
                });
            }
        });

        // Reset exit intent when user types enough
        document.addEventListener('input', () => {
            if (checkTextAmount()) {
                exitIntentShown = false; // Reset so user can leave freely
            }
        });
    </script>
</body>
</html>