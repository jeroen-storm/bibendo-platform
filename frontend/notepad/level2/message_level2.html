<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bericht - Level 2</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
</head>
<body>
    <div class="container">
        
        <div id="aggregatedContent" class="aggregated-content">
            <!-- Aggregated content will be loaded here -->
        </div>
        
        <div class="question">
            <p>Schrijf in 1-2 zinnen op welke sneakerstyle jongeren aanspreekt. Wat hebben SamiraJansen_2010 en say_jay_den gemeen?</p>
        </div>
        
        <div class="form-group">
            <textarea 
                id="noteTextarea" 
                placeholder="Begin hier met typen..."
                maxlength="1000"
            ></textarea>
            <div class="char-counter">0/1000</div>
        </div>
        
        <div class="question">
            <p>Schrijf in 2-3 zinnen op wat de kenmerken zijn van Urban Flow en leg uit waarom deze sneakerstyle goed past bij SneakSpot.</p>
        </div>
        
        <div class="form-group">
            <textarea 
                id="communicationTextarea" 
                placeholder="Begin hier met typen..."
                maxlength="1000"
            ></textarea>
            <div class="char-counter">0/1000</div>
        </div>
        
        <!-- Verstuur naar Emma button -->
        <div class="submit-section">
            <button id="submitToEmma" class="submit-button">Verstuur naar Emma</button>
        </div>
        
        <!-- Auto-save status indicator -->
        <div class="status-message auto-save-status" id="statusMessage"></div>
        
        <!-- Emma submission overlay -->
        <div class="emma-overlay" id="emmaOverlay">
            <div class="emma-popup">
                <div class="emma-icon">âœ…</div>
                <p class="emma-message">Je bericht over Urban Flow is verzonden naar Emma! Ik ben benieuwd wat ze van de nieuwe sneakerstyle vindt.</p>
            </div>
        </div>
        
    </div>
    
    <script src="../../assets/js/notepad.js"></script>
    <script>
        // Simple multi-textarea functionality for final pages
        class MessageManager {
            constructor() {
                this.userId = this.getUserId();
                this.pageId = 'message_level2';  // Message has its own pageId
                // Map textareas to field numbers within the message
                this.textareaMapping = {
                    'noteTextarea': 1,              // Field 1 of message
                    'communicationTextarea': 2      // Field 2 of message
                };
                this.textareas = Object.keys(this.textareaMapping);
                this.init();
            }
            
            getUserId() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('userId') || 'anonymous';
            }
            
            init() {
                // Set up auto-save for all textareas
                this.textareas.forEach(id => {
                    const textarea = document.getElementById(id);
                    if (textarea) {
                        textarea.addEventListener('input', () => this.scheduleAutoSave());
                    }
                });
                
                // Submit to Emma
                const submitButton = document.getElementById('submitToEmma');
                if (submitButton) {
                    submitButton.addEventListener('click', () => this.submitToEmma());
                }
                
                // Load existing content
                this.loadExistingContent();
            }
            
            scheduleAutoSave() {
                if (this.autoSaveTimer) clearTimeout(this.autoSaveTimer);
                this.autoSaveTimer = setTimeout(() => this.saveContent(), 1500);
            }
            
            async saveContent() {
                // Save each textarea as a separate content item with field number
                const savePromises = this.textareas.map(async (textareaId) => {
                    const textarea = document.getElementById(textareaId);
                    const fieldNumber = this.textareaMapping[textareaId];

                    if (textarea && fieldNumber) {
                        return fetch('/api/content/save', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: this.userId,
                                pageId: this.pageId,  // Save to message_level2
                                contentType: 'message',
                                content: textarea.value,
                                fieldNumber: fieldNumber  // Field 1 or 2
                            })
                        });
                    }
                });

                try {
                    await Promise.all(savePromises.filter(Boolean));
                    console.log('Saved all message fields');
                } catch (error) {
                    console.error('Error saving:', error);
                }
            }

            async loadExistingContent() {
                // Load message content from V2 API
                try {
                    const response = await fetch(`/api/content/${this.userId}/${this.pageId}`);
                    if (response.ok) {
                        const contentItems = await response.json();

                        // Load each field by field number
                        contentItems.forEach(item => {
                            if (item.field_number) {
                                // Find textarea by field number
                                const textareaId = Object.keys(this.textareaMapping).find(
                                    key => this.textareaMapping[key] === item.field_number
                                );

                                if (textareaId) {
                                    const textarea = document.getElementById(textareaId);
                                    if (textarea && item.content) {
                                        textarea.value = item.content;
                                        console.log(`Loaded field ${item.field_number}:`, item.content.substring(0, 50));
                                    }
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading message content:', error);
                }
            }
            
            async submitToEmma() {
                await this.saveContent();
                const overlay = document.getElementById('emmaOverlay');
                if (overlay) {
                    overlay.classList.add('show');
                    setTimeout(() => {
                        overlay.classList.remove('show');
                        // Make page 20% transparent after submission
                        this.makePageTransparent();
                    }, 4000);
                }
            }

            makePageTransparent() {
                const container = document.querySelector('.container');
                if (container) {
                    container.style.opacity = '0.2';
                    container.style.pointerEvents = 'none';
                }
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new MessageManager();
        });
    </script>

    <!-- Exit Intent Modal -->
    <div id="exitIntentModal" class="exit-intent-overlay" style="display: none;">
        <div class="exit-intent-popup">
            <div class="exit-intent-header">
                <img src="../../assets/images/karim_popup.png" alt="Karim" class="exit-intent-avatar">
                <h3>Hey, weet je zeker dat je klaar bent?</h3>
            </div>
            <div class="exit-intent-actions">
                <button id="continueWriting" class="exit-intent-btn-secondary">Sluiten</button>
            </div>
        </div>
    </div>

    <script>
        // Exit Intent functionality
        let exitIntentShown = false;
        let isLeavingPage = false;

        function checkTextAmount() {
            const noteTextarea = document.getElementById('noteTextarea');
            const communicationTextarea = document.getElementById('communicationTextarea');

            const totalChars = (noteTextarea?.value || '').length +
                             (communicationTextarea?.value || '').length;

            return totalChars >= 50; // Require at least 50 characters total
        }

        function showExitIntentModal() {
            if (exitIntentShown || isLeavingPage) return;
            if (!checkTextAmount()) return; // Only show if user has written something

            const modal = document.getElementById('exitIntentModal');
            if (modal) {
                modal.style.display = 'flex';
                exitIntentShown = true;
            }
        }

        function hideExitIntentModal() {
            const modal = document.getElementById('exitIntentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Mouse leave detection
        document.addEventListener('mousemove', (e) => {
            if (e.clientY <= 10 && !exitIntentShown) {
                showExitIntentModal();
            }
        });

        // Close modal buttons
        const continueBtn = document.getElementById('continueWriting');
        if (continueBtn) {
            continueBtn.addEventListener('click', hideExitIntentModal);
        }

        // Before unload
        window.addEventListener('beforeunload', () => {
            isLeavingPage = true;
        });
    </script>
</body>
</html>