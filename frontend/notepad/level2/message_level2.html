<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bericht - Level 2</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
</head>
<body>
    <div class="container">
        
        <div id="aggregatedContent" class="aggregated-content">
            <!-- Aggregated content will be loaded here -->
        </div>
        
        <div class="question">
            <p>Noteer in 1-2 zinnen welke sneakerstyle jongeren aanspreekt. Wat hebben SamiraJansen_2010 en say_jay_den gemeen?</p>
        </div>
        
        <div class="form-group">
            <textarea 
                id="noteTextarea" 
                placeholder="Begin hier met typen..."
                maxlength="1000"
            ></textarea>
            <div class="char-counter">0/1000</div>
        </div>
        
        <div class="question">
            <p>Beschrijf Urban Flow in 2-3 zinnen en leg uit waarom deze sneakerstyle goed past bij SneakSpot.</p>
        </div>
        
        <div class="form-group">
            <textarea 
                id="communicationTextarea" 
                placeholder="Begin hier met typen..."
                maxlength="1000"
            ></textarea>
            <div class="char-counter">0/1000</div>
        </div>
        
        <!-- Verstuur naar Emma button -->
        <div class="submit-section">
            <button id="submitToEmma" class="submit-button">Verstuur naar Emma</button>
        </div>
        
        <!-- Auto-save status indicator -->
        <div class="status-message auto-save-status" id="statusMessage"></div>
        
        <!-- Emma submission overlay -->
        <div class="emma-overlay" id="emmaOverlay">
            <div class="emma-popup">
                <div class="emma-icon">âœ…</div>
                <p class="emma-message">Je bericht over Urban Flow is verzonden naar Emma! Benieuwd wat ze van de nieuwe sneakerstyle vindt.</p>
            </div>
        </div>
        
    </div>
    
    <script src="../../assets/js/notepad.js"></script>
    <script>
        // Simple multi-textarea functionality for final pages
        class MessageManager {
            constructor() {
                this.userId = this.getUserId();
                this.pageId = 'message_level2';
                this.textareas = ['noteTextarea', 'communicationTextarea'];
                this.init();
            }
            
            getUserId() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('userId') || 'anonymous';
            }
            
            init() {
                // Set up auto-save for all textareas
                this.textareas.forEach(id => {
                    const textarea = document.getElementById(id);
                    if (textarea) {
                        textarea.addEventListener('input', () => this.scheduleAutoSave());
                    }
                });
                
                // Submit to Emma
                const submitButton = document.getElementById('submitToEmma');
                if (submitButton) {
                    submitButton.addEventListener('click', () => this.submitToEmma());
                }
                
                // Load existing content
                this.loadExistingContent();
            }
            
            scheduleAutoSave() {
                if (this.autoSaveTimer) clearTimeout(this.autoSaveTimer);
                this.autoSaveTimer = setTimeout(() => this.saveContent(), 1500);
            }
            
            async saveContent() {
                const content = {};
                this.textareas.forEach(id => {
                    const textarea = document.getElementById(id);
                    if (textarea) {
                        content[id] = textarea.value;
                    }
                });
                
                try {
                    await fetch('/api/notes/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: this.userId,
                            pageId: this.pageId,
                            content: JSON.stringify(content),
                            editCount: 1,
                            timeSpent: 0
                        })
                    });
                } catch (error) {
                    console.error('Error saving:', error);
                }
            }
            
            async loadExistingContent() {
                try {
                    console.log('Loading content for message_level2');
                    const response = await fetch(`/api/notes/${this.userId}/${this.pageId}`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Received data for message_level2:', data);
                        if (data.content) {
                            let content;
                            try {
                                content = JSON.parse(data.content);
                                console.log('Parsed content for message_level2:', content);
                                Object.keys(content).forEach(textareaId => {
                                    const textarea = document.getElementById(textareaId);
                                    if (textarea) {
                                        textarea.value = content[textareaId];
                                        console.log(`Set ${textareaId} to:`, content[textareaId]);
                                    }
                                });
                            } catch (e) {
                                console.log('Skipping malformed content for message_level2:', e);
                                console.log('Raw content was:', data.content);
                                // Clear any malformed content from database
                                await fetch(`/api/notes/save`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        userId: this.userId,
                                        pageId: this.pageId,
                                        content: '{}',
                                        editCount: 0,
                                        timeSpent: 0
                                    })
                                });
                            }
                        }
                    } else {
                        console.log('No existing content found for message_level2');
                    }
                } catch (error) {
                    console.error('Error loading content for message_level2:', error);
                }
            }
            
            async submitToEmma() {
                await this.saveContent();
                const overlay = document.getElementById('emmaOverlay');
                if (overlay) {
                    overlay.classList.add('show');
                    setTimeout(() => overlay.classList.remove('show'), 4000);
                }
            }
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new MessageManager();
        });
        
        // Debug function to clear all data
        window.clearMessageLevel2 = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId') || 'anonymous';
            
            // Clear from database
            await fetch('/api/notes/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: userId,
                    pageId: 'message_level2',
                    content: '{}',
                    editCount: 0,
                    timeSpent: 0
                })
            });
            
            // Clear textareas
            ['noteTextarea', 'communicationTextarea'].forEach(id => {
                const textarea = document.getElementById(id);
                if (textarea) {
                    textarea.value = '';
                }
            });
            
            console.log('Cleared all message_level2 data');
            location.reload();
        };
    </script>
</body>
</html>